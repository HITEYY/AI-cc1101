name: Build Firmware and App Package

on:
  push:
    branches:
      - main
      - master
    tags:
      - "v*"
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: build-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        env:
          - t-embed-cc1101
          - t-deck
          - cardputer
          - esp32s3-generic
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install PlatformIO
        run: pip install --upgrade platformio

      - name: Build firmware
        run: pio run -e ${{ matrix.env }}

      - name: Package build artifacts
        env:
          PIO_ENV: ${{ matrix.env }}
          VERSION_TAG: ${{ startsWith(github.ref, 'refs/tags/v') && github.ref_name || github.sha }}
          REPO_SLUG: ${{ github.repository }}
          INCLUDE_LATEST_ALIAS: ${{ startsWith(github.ref, 'refs/tags/v') && 'true' || 'false' }}
          INCLUDE_APP_BUNDLE: "true"
        run: bash scripts/package_release_assets.sh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.env }}
          path: dist/*
          if-no-files-found: error
          retention-days: 14

      - name: Copy latest bin for Pages
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          mkdir -p pages-firmware
          for f in dist/openclaw-*-latest.bin; do
            [ -f "$f" ] && cp "$f" pages-firmware/
          done

      - name: Upload Pages firmware artifact
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: pages-firmware-${{ matrix.env }}
          path: pages-firmware/*
          if-no-files-found: ignore
          retention-days: 14


  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Merge artifacts into dist
        run: |
          mkdir -p dist
          for d in all-artifacts/build-*/; do
            cp "$d"* dist/ 2>/dev/null || true
          done
          ls -la dist/

      - name: Generate SHA-256 body
        id: sha256body
        run: |
          body=""
          for f in dist/openclaw-*.bin; do
            [ -f "$f" ] || continue
            name="$(basename "$f")"
            hash="$(sha256sum "$f" | awk '{print $1}')"
            body="${body}<!-- SHA256:${name}=${hash} -->"$'\n'
          done
          # Also add human-readable table
          body="${body}"$'\n'"### SHA-256 Checksums"$'\n'
          body="${body}| File | SHA-256 |"$'\n'
          body="${body}|------|---------|"$'\n'
          for f in dist/openclaw-*.bin; do
            [ -f "$f" ] || continue
            name="$(basename "$f")"
            hash="$(sha256sum "$f" | awk '{print $1}')"
            body="${body}| \`${name}\` | \`${hash}\` |"$'\n'
          done
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "body<<$EOF" >> "$GITHUB_OUTPUT"
          echo "$body" >> "$GITHUB_OUTPUT"
          echo "$EOF" >> "$GITHUB_OUTPUT"

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          target_commitish: ${{ github.sha }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          body: ${{ steps.sha256body.outputs.body }}
          append_body: true
          files: |
            dist/*
          fail_on_unmatched_files: false

  deploy-pages:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download firmware artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: pages-firmware-*
          path: firmware-artifacts

      - name: Prepare Pages site
        run: |
          cp -r web-flusher _site
          mkdir -p _site/firmware
          for d in firmware-artifacts/pages-firmware-*/; do
            cp "$d"*.bin _site/firmware/ 2>/dev/null || true
          done
          ls -la _site/firmware/ || echo "No firmware files"

      - name: Configure GitHub Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
